# List Of Accounts
General terms defined in the [dictionary](dictionary.md)

## Definition
Request the list of bank accounts associated with this PSU's online banking account at the target ASPSP. 

If there is any reference to an existing account information consent (AisConsent) stored in the database of the TPP, the TPP will use this consent reference to forward the service request to the OpenBanking interface of the ASPSP.

If there is no such reference in the database of the TPP, the TPP will respond the FinTech to redirect the PSU to the ConsentAuthorizationApi of the TPP.

In order to uniquely identify the requesting PSU, the TPP uses a unique reference made out of:
- the fintechId : the unique identifier of this FinTech in the realm of the TPP. This parameter is read from the [FinTechContext](dictionary.md#FinTechContext) transported as jwt-Token in the Authorization header of each FinTech request to the TPP.
- the psu-id@fintech : the unique identifier of the PSU in the realm of the FinTech.  This parameter is transported in the HttpHeader named: Fintech-User-ID

## Diagram
![Session diagram](http://www.plantuml.com/plantuml/proxy?src=https://raw.githubusercontent.com/adorsys/open-banking-gateway/develop/docs/architecture/diagrams/useCases/4a-aisListOfAccounts.puml&fmt=svg&vvv=1&sanitize=true)  

## Use Cases
### LoA-010 FinTechUI.displayBankServices
The result of a bank selection is that the FinTechUI displays the [BankProfile](dictionary.md#BankProfile) to the PSU. The bank profile contains the list of services offered by the selected bank. For account information, this list generally contains only the first service "listOfAccounts" as all other account information services rely on the target account selected and identified by account-id. 

### LoA-020 : FinTechUI.selectService(listOfAccounts)
Once selected by the PSU, the FinTechUI forwards the service selected to the FinTechApi. In this case "listOfAccounts". The selection might be accompanied with some service specifications. For listOfAccounts, the option withBalance can be added to indicate that the balance has to be returned as well.

### LoA-030 : FinTechApi.listOfAccounts
Call specification: listOfAccounts[SessionCookie,X-XSRF-TOKEN](withBalance)<p:bank-id>. The FinTechUI issues a listOfAccounts request to the FinTechAPI with:
- __[SessionCookie and X-XSRF-TOKEN](dictionary.md#SessionCookie):__ The SessionCookie is used to maintain the association between PSU and FinTech. It holds a session identifier and the X-XSRF-TOKEN is sent back and forth though the header and used to authenticate the SessionCookie.
- __The bank-id:__ passed as a query parameter and referencing the given [BankProfile](dictionary.md#BankProfile) that contains meta information associated with the selected Bank.
- __withBalance:__ optional, instruct the TPP to request balances associated with each account.
- __X-Request-ID:__ unique identifier that identifies this request throughout the entire processing chain. Shall be contained in HTTP Response as well.
- __[UserAgentContext](dictionary.md#UserAgentContext) (invisible): __ describes details associated with the user agent of the PSU. Generally not visible in the API as they are automatically provided by the user agent. The purpose is to transfer context specific information on the PsuUserAgent and the request that might later be required by the ASPSP like:
  * IP-Address,
  * IP-Port,
  * Accept,
  * Accept-Charset,
  * Accept-Encoding,
  * Accept-Language,
  * Device-ID,
  * User-Agent,
  * PSU-Geo-Location,
  * Http-Method.

### LoA-040 : TppBankingApi.listOfAccounts
Forwards the PSU request to TPP with following associated context informations:

- __Authorization:[FinTechContext](dictionary.md#FinTechContext): __ Contains static identification information associated with the FinTech.
- __Fintech-User-ID: psu-id@fintech:__ the unique identifier of the PSU in the realm of the FinTech
- __Service-Session-ID: UUID:__ a unique identifier generated by the FinTech and used to dinstinguish this service request from other service requests of the same type.
- __Fintech-Redirect-URL-[OK|NOK]<p:auth-id,q:state>:__ these are URL used to redirect control to the FinTechUI application. As we set a RedirectCookie while redirecting the PSU to the ConsentAuthorizationApi of the TPP, this RedirectCookie must be transported back to the FinTechApi with the redirect call. 
  - In order to distinguish redirect cookie associated with different authorization flows, we scope the Fintech-Redirect-URL with a dynamic path parameter "auth-id". This must be set in the RedirectCookie before returning it to the FinTechUI.
  - In order to protect the Fintech-Redirect-URL against XSRF, with a state parameter. This state parameter is defined at initialization of the request, and added as a query parameter to the Fintech-Redirect-URL.
- __Additional Parameters: __ like UserAgentContext, Bank-ID: bank-id, withBalance are described above.

### LoA-041 TppBankingApi.checkAuthorization
verifies the authenticity of the Authorization header "FinTechContext". Returns the extracted fintechId.

### LoA-050 BankingProtocolFacade.listOfAccounts
Forwards the call to the BankingProtocolFacade.

### LoA-051 BankingProtocolFacade.selectBankingProtocol
TppBankingApi selects the [BankingProtocol](dictionary.md#BankingProtocol) based on the given: ServiceSessionId or BankId and ServiceType: "listOfAccounts"

### LoA-060 : BankingProtocol.listOfAccounts
The [BankingProtocol](dictionary.md#BankingProtocol) associated with the given BankProfile decides on how to proceed with the request after loading and analyzing an eventually stored TppConsentSession.

### LoA-061 : BankingProtocol.loadMatchingConsent
ServiceSpec: loadMatchingConsent(fintechUserID,serviceSessionID, bankID, finTechId,"listOfAccounts"):TppConsentSession. If there is an existing consent reference associated with the PSU for the given service, the BankingProtocol will load the corresponding [TppConsentSession](dictionary.md#TppConsentSession). BankingProtocol will then use the loaded TppConsentSession to retrieve an existing consent and proceed to the ASPSP with the service request.

### LoA-062 : BankingProtocol.storeServiceSession
All information associated with the service will then be stored encrypted, alongside the used consent reference if any. This routine returns a serviceSessionKey that can be used to decrypt the serviceSession.

### LoA-070 : No Suitable Consent Present: Create an Authorization Session
If there is no suitable consent available, the BankingProtocol will update the ServiceSession with a new authorization session identified by an auth-id (in the scope of the ServiceSession) and also returning a redirectCode.
- __The auth-id:__ is an identifier of the authorization instance in the context of this PSU. It can be a short alphanumeric string like "asrfvs" used to isolate parallel active authorization sessions from each order. This auth-id will be used by the FinTech to set the path of the corresponding RedirectSession and also used to fill the Fintech-Redirect-URL-[OK|NOK]<p:auth-id,q:state>. 
- __The redirectCode:__ contains: the fintechID, the serviceSessionID, the serviceSessionKey and the auth-id. The redirectCode is used by the ConsentAuthorizationApi of the TPP to access the service record.

### LoA-071, LoA-72, LoA-73: Initiate Redirect
By throwing a redirect exception, the BankingProtocol instructs the BankingProtocolFacade, and the TppBankingApi to initiate a redirect of the PSU to the ConsentAuthorizationApi.

### <a name="LoA-074"></a>LoA-074 : expireSessionCookie(SessionCookie)
Upon redirecting the PSU user agent to the ConsentAuthorizationApi, the regular session between the FinTechUI and the FinTechApi has to be removed in order to avoid unwanted access to the FinTechApi. Even though this is not mandatory as the SessionCookie is protected by an X-XSRF-TOKEN, it is still advisable to do this as the X-XSRF-TOKEN is eventually accessible to javascript code running in the UserAgent.

### <a name="LoA-075"></a>LoA-075 : RedirectCookie
- __Purpose:__ The RedirectCookie is used make sure that the UserAgent that started a redirect flow is the same as the one the terminated that redirect flow. This is essential to assume that the identity the PSU physicaly using this user agent is the same as the one that accessed the authorization interfaces of the (TPP resp. ASPSP).
- __The RedirectCookie:__ is therefore set by the origin of the redirection (FinTech) and must be transported to the FinTechApi when control is sent back to the FinTechUI.
- __Expiration:__ This RedirectCookie shall be set for the max time we think the PSU need to complete authorization of the corresponding consent. Therefore the expiration of this RedirectCookie generally has a longer life span than the expiration of a regular SessionCookie. 
- __CookiePath (auth-id):__ This RedirectCookie must be bound to the "auth-id" path of the Fintech-Redirect-URLs (defined as Fintech-Redirect-URL-[OK|NOK]<p:auth-id,q:state>). so it does no need to be transported to the FinTechApi with any other request. 
- __XSRF Protection (state):__ This RedirectCookie is also protected by a "state" query parameter that is available to the Fintech-Redirect-URLs.
- __User Session__: Generally processing a successful redirect is equivalent to a successful re-establishment of the user session. Meaning that FinTechApi can set a new SessionCookie to maintain the session with the PSU without a new explicit login of the PSU.

### <a name="LoA-076"></a>LoA-076 : FinTechApi redirects userAgent to the ConsentAuthorisationApi
The service response carries a response code 302 instructing the FinTechUI to redirect the PsuUserDevice to the ConsentAuthorisationApi, with following information:
- redirectCode : attached as a query parameter
- SessionCookie : for deletion
- RedirectCookie : with the expected duration of the consent authorization.

### <a name="LoA-080"></a>LoA-080 : Suitable Consent Present
If there is a suitable consent reference in the database of the TPP, this will be loaded and used to forward request to the ASPSP.

### <a name="LoA-081"></a>LoA-081 : Forward Service Request to ASPSP
Service request is forwarded to the [AspspBankingApi](dictionary.md#AspspBankingApi) together with a reference to an AisConsent. The Associated [TppContext](dictionary.md#TppContext) contains TPP identifying information.

#### LoA-082 .. -87 : Returned Service Response if sent and displayed to the PSU.
The returned ListOfAccountsResponse will travel through the call chain back to the FinTechUI and displayed to the PSU.
